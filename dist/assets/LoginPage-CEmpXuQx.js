import{u as q,l as R,r as m,h as M,i as G,j as e,af as K,ag as $,aD as Q,aE as W,aF as J,F as z,o as C,k as g,q as L,R as X,s as O,B as P,a2 as w,$ as T,ao as Z,n as V,G as ee,J as _,a4 as se,z as l,aG as k,a as ae,g as re,L as te,aH as oe,w as le}from"./index-CUSVstqU.js";import{A as ne}from"./AuthWrapper-BHMzU0-9.js";import{F as ie}from"./FormSelect-DiVd6t5g.js";import"./index-BdQq_4o_.js";import"./badge-c_xwgsXg.js";const ce=a=>{const n={role:w().min(1,"Account type is required")};return a==="driver"?T({...n,phone:k}):a==="seller"?T({...n,businessName:w().min(2,"Business name must be at least 2 characters").max(70).trim(),businessAddress:w().min(2,"Business address must be at least 2 characters").max(255).trim(),phone:k,cellPhone:k,einNumber:w().min(1,"EIN number is required"),localDelivery:Z(["yes","no"]),salesTaxId:w().optional()}).refine(c=>c.localDelivery==="no"?c.salesTaxId&&c.salesTaxId.length>0:!0,{message:"Sales Tax ID is required when Local Delivery is No",path:["salesTaxId"]}):T(n)};function de({isOpen:a,userId:n}){const c=q(),{setUser:N,updateUser:F,setIsAuthenticated:U,checkAuth:B}=R(),[i,b]=m.useState(!1),[p,E]=m.useState(""),[y,j]=m.useState("no"),S=M({resolver:G(ce(p)),defaultValues:{role:"",businessName:"",businessAddress:"",phone:"",cellPhone:"",einNumber:"",localDelivery:"no",salesTaxId:""}}),{handleSubmit:A,watch:d,setValue:t,reset:r}=S,o=d("role");m.useEffect(()=>{o&&(E(o),r({role:o,businessName:"",businessAddress:"",phone:"",cellPhone:"",einNumber:"",localDelivery:"no",salesTaxId:""}))},[o,r]),m.useEffect(()=>{const s=d(u=>{u.localDelivery&&j(u.localDelivery)});return()=>s.unsubscribe()},[d]);const h=async s=>{b(!0);try{let u={userId:n,role:s.role};s.role==="driver"?u.phone=s.phone.replace(/\D/g,""):s.role==="seller"&&(u={...u,businessName:s.businessName,businessAddress:s.businessAddress,phone:s.phone.replace(/\D/g,""),cellPhone:s.cellPhone?.replace(/\D/g,"")||"",einNumber:s.einNumber,localDelivery:s.localDelivery==="yes",salesTaxId:s.salesTaxId||""});const D=await V.post("/auth/complete-google-signup",u);if(D.data.status==="success"){const{tokens:v,user:Y}=D.data.data;v&&(localStorage.setItem("access_token",v.accessToken||v.access_token),localStorage.setItem("refresh_token",v.refreshToken||v.refresh_token));try{const f=await ee.fetchQuery({queryKey:se,queryFn:async()=>{const x=await V.get("/auth/me");if(x.data&&x.data.data&&x.data.data.user){const H=x.data.data.user;return _(H)}throw new Error("Invalid user data from /me API")}});if(f)console.log("AuthStore: User profile fetched",f),N(f);else throw new Error("No user data received from /me")}catch(f){if(console.error("AuthStore: Failed to fetch user from /me, using login response",f),D.data.data.user){const x=_(D.data.data.user);N(x)}else throw f}l.success("Account setup completed successfully!");const I=Y||R.getState().user;s.role==="seller"||I?.role==="seller"?c("/seller/dashboard"):s.role==="driver"||I?.role==="driver"?I?.isVehicles?I?.isLicense?c("/driver/dashboard"):c("/auth/driver-license"):c("/auth/vehicle-information"):c("/")}}catch(u){console.error("Role selection error:",u),l.error(u.response?.data?.message||"Failed to complete signup. Please try again.")}finally{b(!1)}};return e.jsx(K,{open:a,onOpenChange:()=>{},children:e.jsxs($,{hideCloseButton:!0,className:"w-[95vw] max-w-[95vw] sm:max-w-[500px] md:max-w-[600px] bg-white max-h-[90vh] overflow-y-auto",onPointerDownOutside:s=>s.preventDefault(),onEscapeKeyDown:s=>s.preventDefault(),children:[e.jsxs(Q,{children:[e.jsx(W,{children:"Select Your Account Type"}),e.jsx(J,{children:"Please select your account type and provide the required information to continue."})]}),e.jsx(z,{...S,children:e.jsxs("form",{onSubmit:A(h),className:"space-y-3 sm:space-y-4 px-2 sm:px-0",children:[e.jsx(ie,{name:"role",label:"Account Type",disabled:i,placeholder:"Select account type",options:[{value:"buyer",label:"Buyer"},{value:"seller",label:"Seller"},{value:"driver",label:"Driver"}]}),p==="driver"&&e.jsx("div",{className:"space-y-4",children:e.jsx(C,{name:"phone",label:"Phone Number",placeholder:"(555) 123-4567",disabled:i})}),p==="seller"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx(g,{name:"businessName",label:"Business Name",type:"text",placeholder:"Business Name",disabled:i,className:"text-base px-4 border-gray-300"}),e.jsx(g,{name:"businessAddress",label:"Business Address",type:"text",placeholder:"Address of sales for materials",disabled:i,className:"text-base px-4 border-gray-300"}),e.jsx(C,{name:"phone",label:"Business Phone",placeholder:"(123) 456-7890",disabled:i,className:"text-base px-4 border-gray-300"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4",children:[e.jsx(C,{name:"cellPhone",label:"Cell Phone",placeholder:"(123) 456-7890",disabled:i,className:"text-base px-4 border-gray-300"}),e.jsx(g,{name:"einNumber",label:"EIN Number",type:"text",placeholder:"EIN number",disabled:i,className:"text-base px-4 border-gray-300"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(L,{children:"Local Delivery Shipping *"}),e.jsxs(X,{value:y,onValueChange:s=>{j(s),t("localDelivery",s)},className:"flex flex-row gap-6 sm:gap-8",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(O,{value:"yes",id:"delivery-yes",className:"h-5 w-5 sm:h-4 sm:w-4"}),e.jsx(L,{htmlFor:"delivery-yes",className:"font-normal cursor-pointer text-base sm:text-sm",children:"Yes"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(O,{value:"no",id:"delivery-no",className:"h-5 w-5 sm:h-4 sm:w-4"}),e.jsx(L,{htmlFor:"delivery-no",className:"font-normal cursor-pointer text-base sm:text-sm",children:"No"})]})]})]}),y==="no"&&e.jsx(g,{name:"salesTaxId",label:"Sales Tax ID / Resale Certificates",type:"text",placeholder:"Sales Tax ID/Resale Certificates",disabled:i,className:"text-base px-4 border-gray-300"})]}),e.jsx(P,{type:"submit",className:"w-full text-white hover:text-white",disabled:i||!p,children:i?"Processing...":"Continue"})]})})]})})}function xe(){const a=q(),n=ae(),{login:c}=re(),[N,F]=m.useState(!1),[U,B]=m.useState(!1),[i,b]=m.useState(!1),[p,E]=m.useState(""),y=M({resolver:G(oe),defaultValues:{email:"",password:""}}),{handleSubmit:j}=y;m.useEffect(()=>{const t=new URLSearchParams(n.search).get("content");t&&(E(t),b(!0))},[n.search]);const S=async d=>{F(!0);try{console.log("Login data:",d),console.log("Starting login process..."),await c(d.email,d.password);const t=R.getState().user,r=typeof n.state?.from=="string"?n.state.from:n.state?.from?.pathname||null,o=n.state?.buyNowItem||null;if(t)if(t.role==="driver"){const h=t.isVehicles||!1,s=t.isLicense||!1;console.log("Driver login - hasVehicles:",h,"hasLicense:",s),h?s?(o&&r==="/checkout"?a(r,{state:{buyNowItem:o}}):a(r||"/driver/dashboard"),l.success("Login successful!")):(a("/auth/driver-license"),l.error("Please upload your driving license!",{icon:"⚠️",style:{background:"#FEF8C6",color:"#000",border:"1px solid #FCE992"}})):(a("/auth/vehicle-information"),l.error("Please upload your vehicle information!",{icon:"⚠️",style:{background:"#FEF8C6",color:"#000",border:"1px solid #FCE992"}}))}else t.role==="seller"?(o&&r==="/checkout"?a(r,{state:{buyNowItem:o}}):a(r||"/seller/dashboard"),l.success("Login successful!")):t.role==="buyer"?(o&&r==="/checkout"?a(r,{state:{buyNowItem:o}}):a(r||"/"),l.success("Login successful!")):(o&&r==="/checkout"?a(r,{state:{buyNowItem:o}}):a(r||"/"),l.success("Login successful!"));else a(r||"/")}catch(t){if(console.error("Login error:",t),t.response?.data?.message==="Account is not verified"){sessionStorage.setItem("signup_email",d.email),l("Your account is not verified. Sending OTP to your email...",{icon:"⚠️",style:{background:"#FEF8C6",color:"#000",border:"1px solid #FCE992"}});try{await le.createOtp({email:d.email,type:"UR"}),localStorage.setItem("otp_resend_timestamp",Date.now().toString()),l.success("OTP sent to your email successfully!"),a("/auth/verify-otp")}catch(r){console.error("Failed to send OTP:",r);const o=r.response?.data?.message||"";if(o.includes("Please wait")){const h=o.match(/(\d+) seconds/),s=h?h[1]:"a few";l(`Please wait ${s} seconds before requesting another OTP`,{icon:"⏰",style:{background:"#FEF8C6",color:"#000",border:"1px solid #FCE992"}}),a("/auth/verify-otp")}else l.error("Failed to send OTP. You can resend it from the next page."),a("/auth/verify-otp")}}else l.error(t.response?.data?.message||"Invalid email or password. Please try again.")}finally{F(!1)}},A=()=>{B(!0);const t="http://localhost:8081/api/v1/auth/google";window.location.href=t};return e.jsxs(ne,{children:[e.jsx(de,{isOpen:i,userId:p,onClose:()=>b(!1)}),e.jsx(z,{...y,children:e.jsxs("form",{onSubmit:j(S),className:"space-y-6",children:[e.jsx(g,{name:"email",label:"Email",type:"email",placeholder:"Enter your email",className:" text-base px-4 border-gray-300"}),e.jsx(g,{name:"password",label:"Password",type:"password",placeholder:"Enter your password",className:"text-base px-4 border-gray-300"}),e.jsx(P,{type:"submit",className:"w-full  bg-primary   hover:bg-primary/80 text-white font-medium text-base",loading:N,children:"Login"}),e.jsx("div",{className:"text-center",children:e.jsx(te,{to:"/auth/forgot-password",className:"text-primary hover:text-primary/80 font-medium",children:"Forgot Password?"})}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 flex items-center",children:e.jsx("div",{className:"w-full border-t border-gray-300"})}),e.jsx("div",{className:"relative flex justify-center text-sm",children:e.jsx("span",{className:"px-4 bg-white text-gray-500",children:"OR"})})]}),e.jsxs(P,{type:"button",variant:"outline",className:"w-full  flex justify-center items-center  border-gray-300 font-medium text-base",onClick:A,disabled:U,children:[e.jsxs("svg",{className:"w-5 h-5 mr-2",viewBox:"0 0 24 24",children:[e.jsx("path",{fill:"#4285F4",d:"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"}),e.jsx("path",{fill:"#34A853",d:"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"}),e.jsx("path",{fill:"#FBBC05",d:"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"}),e.jsx("path",{fill:"#EA4335",d:"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"})]}),"Continue With Google"]}),e.jsx(P,{type:"button",className:"w-full  flex justify-center items-center bg-green-600 hover:bg-green-700 text-white font-medium text-base",onClick:()=>a("/auth/signup"),children:"Create New Account"})]})})]})}export{xe as default};
