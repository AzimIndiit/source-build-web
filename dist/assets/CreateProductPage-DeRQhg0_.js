import{u as Pe,r as p,aj as Ve,ak as De,a3 as X,h as Fe,i as Se,z as m,j as c,F as qe,ac as Ae,B as G,al as Ie,am as Ne,an as Oe,$ as w,a2 as u,ao as D,ap as x,a0 as M,aq as K,n as U}from"./index-CUSVstqU.js";import{P as Z,a as Be}from"./ProductPreview-DXz8ypX9.js";import{b as Ce,c as je}from"./useProductMutations-CP-SVJ5v.js";import{v as H}from"./imageValidation-BOnAwXS7.js";import"./FormSelect-DiVd6t5g.js";import"./index-BdQq_4o_.js";import"./badge-c_xwgsXg.js";import"./PickupHoursSelector-C2PCOgFr.js";import"./colorUtils-BjIcJb6R.js";import"./upload-BVTc7vsb.js";import"./trash-2-BLdsFbCa.js";const $e=w({color:u().trim().regex(/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/,"Please enter a valid HEX color code"),quantity:u().trim().regex(/^(0|[1-9]\d*)$/,"Quantity must be a whole number").refine(t=>{const r=parseInt(t);return!isNaN(r)&&r>=0},"Quantity must be at least 0").refine(t=>{const r=parseInt(t);return!isNaN(r)&&r<=99999},"Quantity must not exceed 99,999"),outOfStock:x().optional(),price:u().trim().min(1,"Price is required").regex(/^\d+(\.\d{1,2})?$/,"Price must be a valid number").refine(t=>parseFloat(t)>0,"Price must be greater than 0"),priceType:D(["sqft","linear","pallet"]).default("sqft").optional(),discount:w({discountType:D(["none","flat","percentage"]),discountValue:u().optional()}).refine(t=>t.discountType!=="none"?t.discountValue&&t.discountValue.trim().length>0:!0,{message:"Discount value is required when discount type is selected",path:["discountValue"]}).refine(t=>{if(t.discountType==="percentage"&&t.discountValue){const r=parseFloat(t.discountValue);return!isNaN(r)&&r>=0&&r<=100}return!0},{message:"Percentage discount must be between 0 and 100",path:["discountValue"]}).refine(t=>{if(t.discountType==="flat"&&t.discountValue){const r=parseFloat(t.discountValue);return!isNaN(r)&&r>=0}return!0},{message:"Flat discount must be a positive number",path:["discountValue"]})}),Ee=w({title:u().trim().min(3,"Title must be at least 3 characters").max(100,"Title must not exceed 100 characters"),price:u().trim().min(1,"Price is required").regex(/^\d+(\.\d{1,2})?$/,"Price must be a valid number with up to 2 decimal places").refine(t=>parseFloat(t)>0,"Price must be greater than 0").refine(t=>parseFloat(t)<=999999.99,"Price must not exceed 999,999.99"),priceType:D(["sqft","linear","pallet"]).default("sqft").optional(),description:u().trim().min(10,"Description must be at least 10 characters").max(2e3,"Description must not exceed 2000 characters"),category:u().trim().min(1,"Category is required").max(50,"Category must not exceed 50 characters"),subCategory:u().trim().min(1,"Sub category is required").max(50,"Sub category must not exceed 50 characters"),quantity:u().trim().regex(/^(0|[1-9]\d*)$/,"Quantity must be a whole number").refine(t=>{const r=parseInt(t);return!isNaN(r)&&r>=0},"Quantity must be at least 0").refine(t=>{const r=parseInt(t);return!isNaN(r)&&r<=99999},"Quantity must not exceed 99,999"),outOfStock:x().optional(),brand:u().trim().min(2,"Brand must be at least 2 characters").max(50,"Brand must not exceed 50 characters").regex(/^[a-zA-Z0-9\s\-&.]+$/,"Brand can only contain letters, numbers, spaces, hyphens, ampersands, and periods").optional().or(K("")),color:u().trim().regex(/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/,"Please enter a valid HEX color code").optional().or(K("")),locationIds:M(u()).min(1,"At least one location is required").max(10,"Maximum 10 locations allowed"),productTag:M(u().trim().min(2,"Each tag must be at least 2 characters").max(30,"Each tag must not exceed 30 characters").regex(/^[a-zA-Z0-9\s\-#]+$/,"Tags can only contain letters, numbers, spaces, hyphens, and hashtags")).max(10,"Maximum 10 tags allowed").default([]),variants:M($e).max(5,"Maximum 5 variants allowed").optional(),marketplaceOptions:w({pickup:x().optional(),shipping:x().optional(),delivery:x().optional()}).required().refine(t=>t.pickup||t.shipping||t.delivery,{message:"At least one marketplace option (Pickup, Shipping, or Delivery) must be selected"}),deliveryDistance:u().trim().optional(),pickupHours:u().trim().optional(),shippingPrice:u().trim().optional(),localDeliveryFree:x().optional(),readyByDays:u().optional(),dimensions:w({width:u().optional(),length:u().optional(),height:u().optional()}).optional(),discount:w({discountType:D(["none","flat","percentage"]),discountValue:u().optional()}).refine(t=>t.discountType!=="none"?t.discountValue&&t.discountValue.trim().length>0:!0,{message:"Discount value is required when discount type is selected",path:["discountValue"]}).refine(t=>{if(t.discountType==="percentage"&&t.discountValue){const r=parseFloat(t.discountValue);return!isNaN(r)&&r>=0&&r<=100}return!0},{message:"Percentage discount must be between 0 and 100",path:["discountValue"]}).refine(t=>{if(t.discountType==="flat"&&t.discountValue){const r=parseFloat(t.discountValue);return!isNaN(r)&&r>=0}return!0},{message:"Flat discount must be a positive number",path:["discountValue"]})}).refine(t=>!(t.marketplaceOptions?.pickup&&!t.pickupHours?.trim()),{message:"Pickup hours are required when pickup option is selected",path:["pickupHours"]}).refine(t=>!(t.marketplaceOptions?.shipping&&!t.shippingPrice?.trim()),{message:"Shipping price is required when shipping option is selected",path:["shippingPrice"]}).refine(t=>{if(t.marketplaceOptions?.shipping&&t.shippingPrice?.trim()){if(!/^\d+(\.\d{1,2})?$/.test(t.shippingPrice))return!1;const g=parseFloat(t.shippingPrice);if(isNaN(g)||g<0)return!1}return!0},{message:"Shipping price must be a valid positive number",path:["shippingPrice"]}).superRefine((t,r)=>{t.marketplaceOptions?.pickup&&!t.pickupHours?.trim()&&r.addIssue({code:"custom",path:["pickupHours"],message:"Pickup hours are required when pickup option is selected"}),t.marketplaceOptions?.shipping&&(t.shippingPrice?.trim()?/^\d+(\.\d{1,2})?$/.test(t.shippingPrice)?parseFloat(t.shippingPrice)<0&&r.addIssue({code:"custom",path:["shippingPrice"],message:"Shipping price must be greater than or equal to 0"}):r.addIssue({code:"custom",path:["shippingPrice"],message:"Shipping price must be a valid number with up to 2 decimals"}):r.addIssue({code:"custom",path:["shippingPrice"],message:"Shipping price is required when shipping option is selected"}))}),Q=[{value:"casing",label:"Casing"},{value:"trim",label:"Trim"},{value:"molding",label:"Molding"},{value:"hardware",label:"Hardware"},{value:"doors",label:"Doors"},{value:"windows",label:"Windows"},{value:"glass",label:"Glass"},{value:"locks",label:"Locks"},{value:"hinges",label:"Hinges"},{value:"frames",label:"Frames"},{value:"panels",label:"Panels"},{value:"handles",label:"Handles"}],R=5;function Je(){const t=Pe(),[r,g]=p.useState([]),[W,F]=p.useState(!1),[J,f]=p.useState(!1),[d,T]=p.useState([]),[Y,S]=p.useState(!1),[ee,q]=p.useState(null),[k,_]=p.useState(!1),[z,A]=p.useState(!1),[v,te]=p.useState(""),{data:P,refetch:ie}=Ve(),L=De(),I=Ce(),N=je(),{data:se,isLoading:re}=X({queryKey:["categories-active"],queryFn:async()=>(await U.get("/categories",{params:{limit:100}})).data.data.filter(o=>o.isActive)}),{data:ae,isLoading:oe}=X({queryKey:["subcategories",v],queryFn:async()=>v?(await U.get("/subcategories",{params:{category:v,limit:100}})).data.data.filter(o=>o.isActive):[],enabled:!!v}),O=se?.map(e=>({value:e._id,label:e.name}))||[],B=ae?.map(e=>({value:e._id,label:e.name}))||[],V=Array.isArray(P?.data)?P.data:P?.data?[P.data]:[],C=V.map(e=>({value:e.id||e._id||"",label:`${e.name} , ${e.formattedAddress}`||""})),y=Fe({resolver:Se(Ee),mode:"onChange",reValidateMode:"onChange",defaultValues:{title:"",price:"",priceType:"sqft",description:"",category:"",subCategory:"",quantity:"",brand:"",color:"",locationIds:[],productTag:[],variants:[],marketplaceOptions:{pickup:!1,shipping:!1,delivery:!1},deliveryDistance:"50",localDeliveryFree:!1,pickupHours:"",shippingPrice:"200",readyByDate:"",readyByTime:"",readyByDays:"0",dimensions:{width:"",length:"",height:""},discount:{discountType:"none",discountValue:""}}}),{handleSubmit:ne,watch:ce,getValues:le,setValue:h,setFocus:j,clearErrors:Me,setError:$,formState:{errors:He}}=y,b=ce();p.useEffect(()=>{b.category!==v&&(te(b.category),y.setValue("subCategory",""))},[b.category,v,y]);const ue=p.useCallback(e=>{e.preventDefault(),e.stopPropagation(),e.type==="dragenter"||e.type==="dragover"?F(!0):e.type==="dragleave"&&F(!1)},[]),de=p.useCallback(async e=>{if(e.preventDefault(),e.stopPropagation(),F(!1),e.dataTransfer.files&&e.dataTransfer.files[0]){const a=Array.from(e.dataTransfer.files),{validFiles:o,errors:i}=await H(a,R,r.length);o.length>0&&(g(s=>[...s,...o]),f(!1)),i.forEach(s=>m.error(s))}},[r]),pe=async e=>{if(e.target.files){const a=Array.from(e.target.files),{validFiles:o,errors:i}=await H(a,R,r.length);o.length>0&&(g(s=>[...s,...o]),f(!1)),i.forEach(s=>m.error(s)),e.target.value=""}},me=e=>{g(a=>a.filter((o,i)=>i!==e))},ge=async e=>{if(r.length<2){f(!0),m.error("Please upload at least 2 product images"),window.scrollTo({top:0,behavior:"smooth"});return}f(!1);const a=d.map((s,l)=>({variant:s,index:l})).filter(({variant:s})=>s.images.length>0).map(({variant:s,index:l})=>({variantId:s.id,variantIndex:l,files:s.images}));console.log("Variants from form:",e.variants),console.log("Variant files to upload:",a);let o;if(e.readyByDate){const s=e.readyByTime||"00:00";o=new Date(`${e.readyByDate}T${s}:00`).toISOString()}const i={title:e.title,price:parseFloat(e.price),priceType:e.priceType,description:e.description,category:e.category,subCategory:e.subCategory,quantity:parseInt(e.quantity),outOfStock:e.outOfStock,brand:e.brand,color:e.color,locationIds:e.locationIds,productTag:e.productTag,marketplaceOptions:e.marketplaceOptions,pickupHours:e.pickupHours,deliveryDistance:e.deliveryDistance?parseFloat(e.deliveryDistance):void 0,shippingPrice:e.shippingPrice?parseFloat(e.shippingPrice):void 0,localDeliveryFree:e.localDeliveryFree,readyByDate:o,readyByTime:e.readyByTime,readyByDays:e.readyByDays?parseInt(e.readyByDays):void 0,dimensions:e.dimensions&&(e.dimensions.width||e.dimensions.length||e.dimensions.height)?{width:e.dimensions.width?parseFloat(e.dimensions.width):void 0,length:e.dimensions.length?parseFloat(e.dimensions.length):void 0,height:e.dimensions.height?parseFloat(e.dimensions.height):void 0}:void 0,discount:{discountType:e.discount.discountType,discountValue:e.discount.discountValue?parseFloat(e.discount.discountValue):void 0},variants:d.map((s,l)=>{const n=e.variants?.[l];return n?{color:n.color,quantity:parseInt(n.quantity),price:parseFloat(n.price),priceType:n.priceType||e.priceType||"sqft",outOfStock:n.outOfStock??!1,discount:{discountType:n.discount.discountType,discountValue:n.discount.discountValue?parseFloat(n.discount.discountValue):void 0}}:null}).filter(Boolean),imageFiles:r,variantFiles:a.length>0?a:void 0};try{await I.mutateAsync(i),t("/seller/products")}catch(s){console.error("Failed to create product:",s)}},fe=async()=>{const e=le();if(!e.title||e.title.trim().length===0){m.error("Title is required to save as draft"),j("title"),$("title",{message:"Title is required to save as draft"});return}if(!e.category||e.category.trim().length===0){m.error("Category is required to save as draft"),j("category"),$("category",{message:"Category is required to save as draft"});return}if(!e.price||e.price.trim().length===0){m.error("Price is required to save as draft"),j("price"),$("price",{message:"Price is required to save as draft"});return}if(r.length<2){f(!0),m.error("At least 2 images are required to save as draft"),window.scrollTo({top:0,behavior:"smooth"});return}f(!1);const a=d.map((s,l)=>({variant:s,index:l})).filter(({variant:s})=>s.images.length>0).map(({variant:s,index:l})=>({variantId:s.id,variantIndex:l,files:s.images}));let o;if(e.readyByDate){const s=e.readyByTime||"00:00";o=new Date(`${e.readyByDate}T${s}:00`).toISOString()}const i={title:e.title,imageFiles:r};e.price&&e.price.trim()&&(i.price=e.price),e.priceType&&(i.priceType=e.priceType),e.description&&e.description.trim()&&(i.description=e.description),e.category&&e.category.trim()&&(i.category=e.category),e.subCategory&&e.subCategory.trim()&&(i.subCategory=e.subCategory),e.quantity&&e.quantity.trim()&&(i.quantity=e.quantity),e.outOfStock!==void 0&&(i.outOfStock=e.outOfStock),e.brand&&e.brand.trim()&&(i.brand=e.brand),e.color&&e.color.trim()&&(i.color=e.color),e.locationIds&&e.locationIds.length>0&&(i.locationIds=e.locationIds),e.productTag&&e.productTag.length>0&&(i.productTag=e.productTag),e.marketplaceOptions&&(e.marketplaceOptions.pickup||e.marketplaceOptions.shipping||e.marketplaceOptions.delivery)&&(i.marketplaceOptions=e.marketplaceOptions),e.pickupHours&&e.pickupHours.trim()&&(i.pickupHours=e.pickupHours),e.shippingPrice&&e.shippingPrice.trim()&&(i.shippingPrice=e.shippingPrice),e.deliveryDistance&&e.deliveryDistance&&(i.deliveryDistance=e.deliveryDistance),e.localDeliveryFree!==void 0&&(i.localDeliveryFree=e.localDeliveryFree),o&&(i.readyByDate=o,i.readyByTime=e.readyByTime),e.readyByDays&&e.readyByDays.trim()&&(i.readyByDays=parseInt(e.readyByDays)),e.dimensions&&(e.dimensions.width||e.dimensions.length||e.dimensions.height)&&(i.dimensions={width:e.dimensions.width||"",length:e.dimensions.length||"",height:e.dimensions.height||""}),e.discount&&e.discount.discountType!=="none"&&e.discount.discountValue&&e.discount.discountValue.trim()&&(i.discount={discountType:e.discount.discountType,discountValue:e.discount.discountValue}),e.outOfStock!==void 0&&(i.outOfStock=e.outOfStock),d&&d.length>0&&(i.variants=d.map((s,l)=>{const n=e.variants?.[l];return n?{color:n.color,quantity:n.quantity,price:n.price,priceType:n.priceType||e.priceType||"sqft",outOfStock:n.outOfStock??!1,discount:n.discount.discountType!=="none"&&n.discount.discountValue&&n.discount.discountValue.trim()?{discountType:n.discount.discountType,discountValue:n.discount.discountValue}:{discountType:"none",discountValue:""}}:null}).filter(Boolean)),a.length>0&&(i.variantFiles=a);try{console.log("draftData",i),await N.mutateAsync(i),t("/seller/products")}catch(s){console.error("Failed to save draft:",s)}},he=e=>{if(console.log("Form errors:",e),r.length<2){f(!0),m.error("Please upload at least 2 product images"),setTimeout(()=>{const o=document.getElementById("photos");if(o){const i=o.closest(".overflow-y-auto");if(i){const s=o.getBoundingClientRect(),l=i.getBoundingClientRect();i.scrollTop+=s.top-l.top-100}else o.scrollIntoView({behavior:"smooth",block:"start"})}},100);return}const a=Object.keys(e)[0];if(a){const o=e[a];o?.message&&m.error(o.message),setTimeout(()=>{const i=document.querySelector(`[name="${a}"]`);if(i){const s=i.closest(".overflow-y-auto");if(s){const l=i.getBoundingClientRect(),n=s.getBoundingClientRect(),ke=s.scrollTop+l.top-n.top-100;s.scrollTo({top:ke,behavior:"smooth"}),setTimeout(()=>{i.focus()},500)}else i.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{i.focus()},500)}},100)}},ye=async e=>{try{await L.mutateAsync(e),await ie(),A(!1)}catch(a){console.error("Failed to add address:",a),m.error("Failed to add address")}},ve=()=>{if(d.length>=5){m.error("Maximum 5 variants allowed");return}const e={id:Date.now().toString(),images:[],color:"#000000"};T([...d,e]),S(!0);const a=d.length;h(`variants.${a}.color`,""),h(`variants.${a}.discount.discountType`,"none"),h(`variants.${a}.quantity`,""),h(`variants.${a}.price`,""),h(`variants.${a}.priceType`,b.priceType||"sqft"),h(`variants.${a}.discount.discountValue`,"")},be=e=>{const a=d.findIndex(l=>l.id===e),o=d.filter(l=>l.id!==e);T(o);const s=(y.getValues("variants")||[]).filter((l,n)=>n!==a);h("variants",s),a!==-1&&y.clearErrors(`variants.${a}`),o.length===0&&(S(!1),h("variants",[]))},E=p.useCallback(async(e,a)=>{const o=d.find(n=>n.id===e);if(!o)return;const i=5,{validFiles:s,errors:l}=await H(a,i,o.images.length);s.length>0&&T(d.map(n=>n.id===e?{...n,images:[...n.images,...s]}:n)),l.forEach(n=>m.error(n))},[d]),xe=(e,a)=>{T(d.map(o=>o.id===e?{...o,images:o.images.filter((i,s)=>s!==a)}:o))},we=p.useCallback((e,a)=>{e.preventDefault(),e.stopPropagation(),e.type==="dragenter"||e.type==="dragover"?q(a):e.type==="dragleave"&&q(null)},[]),Te=p.useCallback((e,a)=>{if(e.preventDefault(),e.stopPropagation(),q(null),e.dataTransfer.files&&e.dataTransfer.files[0]){const o=Array.from(e.dataTransfer.files);E(a,o)}},[E]);return c.jsxs(qe,{...y,children:[c.jsxs("div",{className:"h-screen bg-gray-50 fixed top-0 w-full z-50 left-0 flex flex-col  ",children:[c.jsx("div",{className:"bg-primary px-4 py-3",children:c.jsxs("div",{className:"flex items-center justify-between",children:[c.jsxs("div",{className:"flex items-center gap-2 sm:gap-4",children:[c.jsx("button",{onClick:()=>t(-1),className:"text-white hover:bg-white  hover:text-black p-1 rounded cursor-pointer",children:c.jsx(Ae,{className:"h-5 w-5 sm:h-6 sm:w-6"})}),c.jsxs("div",{children:[c.jsx("div",{className:"text-xs text-blue-100",children:"Marketplace"}),c.jsx("div",{className:"text-white text-sm sm:text-base font-medium",children:"Item for sale"})]})]}),c.jsx("div",{className:"flex items-center gap-2",children:c.jsx(G,{type:"button",onClick:fe,variant:"ghost",className:"text-white hover:bg-white border border-white h-[40px] sm:h-[48px] text-sm sm:text-base hover:text-primary px-3 sm:px-4",disabled:I.isPending||N.isPending,children:N.isPending?"Saving...":"Save Draft"})})]})}),c.jsx("div",{className:"lg:hidden fixed bottom-4 right-4 z-50",children:!k&&c.jsx(G,{type:"button",onClick:()=>_(!k),className:"bg-primary text-white  p-3 shadow-sm hover:bg-primary/90  rounded-sm flex gap-3 w-fit h-10",children:k?c.jsxs(c.Fragment,{children:[c.jsx("span",{children:"Hide Preview "})," ",c.jsx(Ie,{className:"h-6 w-6"})]}):c.jsxs(c.Fragment,{children:[c.jsx("span",{children:"Show Preview "})," ",c.jsx(Ne,{className:"h-6 w-6"})]})})}),k&&c.jsx("div",{className:"lg:hidden fixed inset-0 z-[100] bg-white overflow-y-auto",children:c.jsx("div",{className:"min-h-screen",children:c.jsx(Z,{handleBackClick:()=>_(!1),formValues:b,uploadedPhotos:r,addressOptions:C,savedAddresses:V,variants:d,categoryOptions:O,subCategoryOptions:B,tagOptions:Q})})}),c.jsxs("form",{id:"product-form",onSubmit:ne(ge,he),className:"flex-1 flex flex-col lg:flex-row gap-4 p-4 mx-auto overflow-hidden min-h-0  w-full",children:[c.jsx("div",{className:"w-full lg:max-w-[450px] h-full",children:c.jsx(Be,{methods:y,uploadedPhotos:r,setUploadedPhotos:g,imageError:J,setImageError:f,addressOptions:C,showAddAddressModal:z,setShowAddAddressModal:A,variants:d,showVariants:Y,setShowVariants:S,handleDrag:ue,handleDrop:de,handleFileChange:pe,removePhoto:me,addVariant:ve,removeVariant:be,handleVariantImageUpload:E,removeVariantImage:xe,handleVariantDrag:we,handleVariantDrop:Te,dragActive:W,variantDragActive:ee,MAX_IMAGES:R,categoryOptions:O,subCategoryOptions:B,tagOptions:Q,isLoading:I.isPending,categoriesLoading:re,subcategoriesLoading:oe})}),c.jsx("div",{className:"w-full lg:flex-1 hidden lg:block h-full",children:c.jsx(Z,{formValues:b,uploadedPhotos:r,addressOptions:C,savedAddresses:V,variants:d,categoryOptions:O,subCategoryOptions:B,tagOptions:Q})})]})]}),c.jsx(Oe,{isOpen:z,onClose:()=>A(!1),onSubmit:ye,isSubmitting:L.isPending,totalAddress:V.length!==0})]})}export{Je as default};
